var L=Object.defineProperty;var F=(t,e,o)=>e in t?L(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var p=(t,e,o)=>(F(t,typeof e!="symbol"?e+"":e,o),o);import{a as h}from"./axios.ea5872bc.js";import{ah as c,ai as _,aj as O}from"./index.4f390c6a.js";import{M as U}from"./constant.a3c7e21e.js";const N="https://fc-mp-4e0c63a5-9df8-4ff7-9ddc-6cb1df6995f4.next.bspapp.com",m=6e4,d=class{constructor(){p(this,"uniHttp");this.uniHttp=h.create({timeout:m,headers:{"Access-Control-Allow-Origin":"*","Content-Type":"application/json"}})}static getInstance(){return d.instance||(d.instance=new d),d.instance}async request(e,o){return new Promise((r,i)=>{const n=new URL(`/${e}`,N);n.protocol="https",n.search=new URLSearchParams(o.query).toString(),console.log("UniCloudObject url.href:",n.href),o.body?this.uniHttp.post(n.href,o.body).then(a):this.uniHttp.get(n.href).then(a);function a(l){console.log("UniCloudObject res:",l),l.data&&[200,201].includes(l.status)?r(l.data):i(l.errMsg)}})}};let g=d;p(g,"instance");async function T(t,e){if(t){console.log("uploadMediaFile file:",t),console.log("uploadMediaFile originFileUrl:",e);try{const o=await t.arrayBuffer(),r=String.fromCharCode(...new Uint8Array(o)),i=window.btoa(r),n=await u.request("uploadFiles/media",{query:{cloudPath:`${t.type.split("/")[0]}/${t.name}`,cloudPathAsRealPath:!0,originFile:e},body:i});if(console.log("uploadMediaFile res:",n),n.fileID)return n.fileID}catch(o){console.error("uploadMediaFile error:",o)}}}let s=[];const u=g.getInstance();async function k(){let t=!0;if(c.has("__QPCF_LOCAL_LOGIN_USER_INFO"))if(_.has("__QPCF_TAB1_FIRST_ENTRY")){console.log("firstEntry exist.");const e=c.getItem("__QPCF_LOCAL_LOGIN_USER_INFO");if(console.log("Tabs usersInfo: ",e),e[0].tokenExpired-10*U<Date.now()){console.log("token is expired: ",e[0].tokenExpired);const o=await P(e[0]);console.log("tokenExpired result: ",o),o&&(t=!o.info);const r=t?`${e[0].name} \u91CD\u65B0\u767B\u5F55\u5931\u8D25`:`${e[0].name} \u91CD\u65B0\u767B\u5F55\u6210\u529F`;_.set("__QPCF_SESSION_LOGIN_MESSAGE",r)}else t=!1}else _.set("__QPCF_TAB1_FIRST_ENTRY",!0);return t}async function P(t){console.log("localStorage: ",c.getAll());let e;try{t?(e=await w(t),console.log("\u5207\u6362\u7528\u6237 result:",e)):c.has("__QPCF_LOCAL_LOGIN_USER_INFO")?(s=c.getItem("__QPCF_LOCAL_LOGIN_USER_INFO"),console.log("Has username, login."),e=await w(s[0]),console.log("result:",e)):(console.log("No users info, register new user."),e=await I(),console.log("result:",e)),e.info&&(await y(e.info.uid),C(e.info))}catch(o){console.error("pcf_Login Error:",o)}return e}async function M(){let t={res:null};try{t=await I(),console.log("result:",t),t.info&&(await y(t.info.uid),C(t.info))}catch(e){console.error("pcf_autoRegister Error:",e)}return t}async function y(t){const e=await u.request("databaseCRUD/get",{query:{collection:"uni-id-users",condition:JSON.stringify({_id:t})}});return console.log("user:",e),e.data.length&&_.set("__QPCF_SESSION_LOGIN_USER_DATA",e.data[0]),e.errCode}async function q(t,e){let o="\u5BC6\u7801\u66F4\u65B0\u5931\u8D25",r="",i="negative",n="center",a=!1;try{s=c.getItem("__QPCF_LOCAL_LOGIN_USER_INFO"),console.log("uniUpdatePassword usersInfo:",s);const l=e.toLowerCase().trim(),f=await u.request("uni-id-co/updatePwd",{body:{clientInfo:{uniPlatform:"web",appId:"__UNI__C89ADDB"},uniIdToken:s[0].token,params:{oldPassword:t,newPassword:l}}});console.log("uniUpdatePassword res:",f),f.errCode===0&&(s[0].password=l,f.newToken&&(s[0].token=f.newToken.token,s[0].tokenExpired=f.newToken.tokenExpired),c.set("__QPCF_LOCAL_LOGIN_USER_INFO",s),a=!0,o="\u5BC6\u7801\u66F4\u65B0\u6210\u529F",i="positive",n="bottom")}catch(l){r=typeof l=="string"?l:JSON.stringify(l),console.error("uni_id_co_Login Error:",l)}return O.create({type:i,position:n,message:o,caption:r}),a}async function w(t){const e={res:null};try{const o=await u.request("uni-id-co/login",{body:JSON.stringify({clientInfo:{uniPlatform:"web",appId:"__UNI__C89ADDB"},params:{username:t.name.toLowerCase(),password:t.password}})});console.log("loginRes:",o),e.res={...o},o.errCode===0&&o.uid&&(e.info={...t,...o.newToken,uid:o.uid})}catch(o){console.error("uni_id_co_Login Error:",o)}return e}async function I(){const t={res:null},e=E(12);console.log("password:",e);const o="16767784457894093216";try{const r=await u.request("getCaptcha/sceneCode",{query:{scene:"register",deviceId:o}});console.log("captcha:",r);let i=!0,n;for(;i;){n=S(16).toLowerCase(),console.log("name:",n);const a=await u.request("uni-id-co/registerUser",{body:JSON.stringify({clientInfo:{uniPlatform:"web",appId:"__UNI__C89ADDB",deviceId:o},params:{username:n,password:e,captcha:r.code}})});if(console.log("loginRes:",a),t.res={...a},a.errCode===0&&a.uid)i=!1,t.info={name:n,password:e,...a.newToken,uid:a.uid,isLocal:!0};else if(!(a.errCode==="uni-id-account-exists"&&a.ErrMsg==="Account exists"))break}}catch(r){console.error("uni_id_co_register Error:",r)}return t}function S(t){const e="abcdefghijklmnopqrstuvwxyz0123456789";let o="";for(let r=0;r<t;r++)o+=e.charAt(Math.floor(Math.random()*e.length));return o}function E(t){const e="abcdefghijklmnopqrstuvwxyz0123456789!#$%&_";let o="";for(let r=0;r<t;r++)o+=e.charAt(Math.floor(Math.random()*e.length));return o}function C(t){if(s.length){const e=s.findIndex(o=>o.name===t.name);e===0?s[0]=t:(e>0?s.splice(e,1):s.length>2&&s.splice(s.length-1,1),console.log("usersInfo.splice:",s.length),s.unshift(t),console.log("usersInfo.unshift:",s.length))}else s.push(t);c.set("__QPCF_LOCAL_LOGIN_USER_INFO",s)}async function x(t,e){return new Promise((o,r)=>{const i=e.host?h.create({baseURL:e.host,timeout:e.timeout||m,headers:e.headers}):h.create({timeout:e.timeout||m,headers:e.headers}),n=a=>{a.data&&[200,201].includes(a.status)?o(a.data):r(a.errMsg)};e.host?e.body?i.post(t,e.body,{params:e.query}).then(n):i.get(t,{params:e.query}).then(n):i.get(t).then(n)})}async function B(t,e){try{const o=await t.arrayBuffer();console.log("uniUploadImage uploadFiles buffer:",o);const r=String.fromCharCode(...new Uint8Array(o)),i=window.btoa(r),n=await u.request("uploadFiles/media",{query:{cloudPath:`${t.type.split("/")[0]}/${t.name}`,cloudPathAsRealPath:!0,originFile:e},body:i});if(console.log("uniUploadImage res:",n),n.fileID)return n.fileID}catch(o){console.error("uniUploadImage Error:",o)}return""}export{g as U,k as a,M as b,x as c,T as d,y as e,q as f,P as p,B as u};
