import{Q as I}from"./QPage.e32daf6c.js";import{C as W,A as j,p as R,c as z,d as L,f as N}from"./index.33274daf.js";import{d as C,r as u,w as x,m as f,n as D,v as U,aT as h,p as Q,j as v,x as w}from"./index.4f390c6a.js";import{_ as V}from"./CollectionSelect.2d35001e.js";import{_ as J}from"./ServiceItemDate.f26f4f48.js";import{u as K}from"./SearchKey.a606d0cd.js";import{U as G}from"./cloudDB.d318324a.js";import{b as S}from"./constant.a3c7e21e.js";import"./QSelect.8ad877e3.js";import"./QChip.17ac3977.js";import"./QItemLabel.95b24a48.js";import"./QMenu.75c03351.js";import"./selection.1482bdb7.js";import"./rtl.0738a96b.js";import"./format.6396bb17.js";import"./index.d9f23821.js";import"./index.4024674e.js";import"./TouchPan.5282a72c.js";import"./QDate.3db3b100.js";import"./use-cache.8fbad985.js";import"./date.865a2574.js";import"./ClosePopup.14229a43.js";import"./vue-i18n.runtime.b0371a81.js";import"./axios.ea5872bc.js";const A=C({__name:"OrderChart",props:{data:{},title:{default:""}},setup(b){W.register(j,R,z,L);const c=u(),p=b,d=u({responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:"",align:"center"},legend:{display:!0,labels:{boxWidth:14,padding:14,textAlign:"right"}}}});return x(()=>p.title,t=>{console.log("watch props.title:",t),t&&(d.value.plugins.title.text=t,console.log("watch options.value.plugins:",d.value.plugins))},{immediate:!0,deep:!0}),(t,_)=>t.data&&d.value?(f(),D(U(N),{key:0,ref_key:"orderDoughnut",ref:c,data:t.data,options:d.value},null,8,["data","options"])):h("",!0)}}),H={key:0,class:"q-ma-none"},M={key:1,class:"q-my-lg"},be=C({__name:"OrdersStat",setup(b){const c=K(),p=u(),d=u(new Date().toDateString()),t=["Revenue","Orders","Programs"],_=["9:00~12:00","13:00~18:00","19:00~23:00"],B=u(["#41B883","#E46651","#00D8FF","#9900EE"]),s=u({labels:[],datasets:[]}),l=u({labels:[],datasets:[]}),y=u(""),F=u("\u6309\u65F6\u95F4\u6BB5\u7EDF\u8BA1"),E=G.getInstance();x(()=>p.value,async a=>{var r;if(a)try{const e=await E.request("getDetails/orderProgram",{query:{collection:"pcf-orders",condition:JSON.stringify({where:`fountain_id=="${a}" && status < 6`,orderBy:"start desc",fountainWhere:"_id != null",fountainField:"_id, program_types",programWhere:"_id != null",programField:"_id, name, type",outWhere:"size(program_id) > 0",outField:"program_id, fountain_id, show_id, paid, status, start, show_date, created_at",skip:0,outLimit:100})}});if(console.log("orders res:",e),e!=null&&e.length){const i=e;let o=0;for(const n of i)o+=n.paid;y.value=`\u5F53\u65E5\u8425\u6536\u603B\u989D\uFF1A${o} \u5143`,F.value=`\u5F53\u65E5\u8BA2\u5355\u603B\u6570\uFF1A${i.length} \u4E2A`,console.log("orders programTitle:",y.value),P(i),T(i)}else!e.success&&((r=e.error)==null?void 0:r.message)&&(/resource exhausted/.test(e.error.message)?console.warn("DB resource exhausted."):console.warn("watch media Error:",e.error.message)),s.value={labels:[],datasets:[]},l.value={labels:[],datasets:[]}}catch(e){console.error("cloudObj orders:",e)}},{immediate:!0});function P(a){s.value.datasets=new Array(t.length).fill({}),s.value.labels=a[0].fountain_id[0].program_types;let r=s.value.labels.length;if(r>0){for(let e=0;e<t.length;e++){s.value.datasets[e]={label:t[e],data:new Array(r).fill(0),backgroundColor:B.value};const i=new Set;for(const o of a){const n=s.value.labels.findIndex(m=>m===o.program_id[0].type);n>-1&&(e===0?s.value.datasets[e].data[n]+=o.paid:e===1?s.value.datasets[e].data[n]+=1:e===2&&(i.add(o.program_id[0]._id),s.value.datasets[e].data[n]=i.size))}}console.log("watch dataByProgramTypes.value:",s.value)}}function T(a){l.value.datasets=new Array(t.length).fill({}),l.value.labels=_;let r=_.length;if(r>0){for(let e=0;e<t.length;e++){l.value.datasets[e]={label:t[e],data:new Array(r).fill(0),backgroundColor:B.value};const i=new Set;for(const o of a){const n=[];for(const g of _){const k=[];k.push(S(g,o.show_date,"start"),S(g,o.show_date,"end")),n.push(k)}const m=n.findIndex(g=>o.start>=g[0]&&o.start<=g[1]);m>-1&&(e===0?l.value.datasets[e].data[m]+=o.paid:e===1?l.value.datasets[e].data[m]+=1:e===2&&(i.add(o.program_id[0]._id),l.value.datasets[e].data[m]=i.size))}}console.log("watch dataByShowTypes.value:",l.value)}}function q(){c.getShow||c.toggleShow()}function O(){c.getShow&&c.toggleShow()}function $(a){console.log("onFountainPick data:",a),a&&a._id!==p.value&&(p.value=a._id)}return(a,r)=>(f(),D(I,{padding:"",class:"q-mx-sm"},{default:Q(()=>[v(V,{class:"q-mt-md",onSelected:$,onClick:q}),p.value?(f(),w("div",{key:0,onClick:O},[v(J,{class:"q-mt-xs",title:"\u8BA2\u5355\u7EDF\u8BA1",isDate:"",isWeekday:"",date_value:d.value,"onUpdate:date_value":r[0]||(r[0]=e=>d.value=e)},null,8,["date_value"]),s.value.labels.length?(f(),w("div",H,[v(A,{title:y.value,data:s.value},null,8,["title","data"])])):h("",!0),l.value.labels.length?(f(),w("div",M,[v(A,{title:F.value,data:l.value},null,8,["title","data"])])):h("",!0)])):h("",!0)]),_:1}))}});export{be as default};
