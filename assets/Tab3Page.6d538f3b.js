import{d as j,r as d,w as C,m,x as v,j as r,n as S,p as s,aT as A,t as w,s as P,F as L,y as U,z as V,A as N,bb as M,B as Q,G as O,q as y,aP as H,c as R,l as G,a as Y,D as J,v as b}from"./index.4f390c6a.js";import{Q as W}from"./QTab.9dfb2d2e.js";import{Q as X}from"./QTabs.1c1f66ed.js";import{Q as Z}from"./QChip.17ac3977.js";import{Q as K}from"./QToolbarTitle.5e2b8a84.js";import{Q as ee}from"./QToolbar.582a7924.js";import{Q as ae}from"./QPageSticky.0fc5d889.js";import{Q as te}from"./QPage.e32daf6c.js";import{F as se,_ as oe}from"./FountainCard.02b690d3.js";import{Q as re}from"./QInnerLoading.b1f69d49.js";import{Q as q}from"./QItemLabel.95b24a48.js";import{Q as le}from"./QBadge.2339051b.js";import{Q as ne}from"./QList.423862dd.js";import{Q as ie,a as ue}from"./QInfiniteScroll.281273f1.js";import{U as z}from"./cloudDB.d318324a.js";import{e as ce}from"./constant.a3c7e21e.js";import{d as F}from"./date.865a2574.js";import{u as de}from"./use-quasar.4e14d354.js";import{u as me}from"./SearchKey.a606d0cd.js";import"./QResizeObserver.cb7e3544.js";import"./rtl.0738a96b.js";import"./QImg.a4aaed75.js";import"./axios.ea5872bc.js";import"./format.6396bb17.js";const fe={class:"q-py-md"},pe=["src"],he={class:"row justify-center q-my-md"},ve={key:1,class:"q-pt-xl text-orange text-h6 text-center"},$=20,_e=j({__name:"PlayList",props:{showIndex:{default:0},show:{},showsLength:{default:0},search:{default:""}},emits:["selected"],setup(D,{emit:_}){const g=d(!0),p=d(""),a=D,l=d([]),i=d([]),h=d([]),T=z.getInstance(),k=_;C(()=>a.show,async n=>{var u;if(console.log("watch props: ",a),n){for(;(u=l.value)!=null&&u.length;)l.value.pop(),h.value.pop();l.value=Array(a.showsLength).fill([]),h.value=Array(a.showsLength).fill(!1),await x()}},{immediate:!0}),C(()=>a.search,async n=>{console.log("watch props.search: ",Boolean(n)),h.value[a.showIndex]?B(n):await x(n)});async function x(n){var u;try{const c=n&&n.length>0;let e=`fountain_id=='${a.show.fountain_id}'`;c&&(e+=` && ${new RegExp(n,"i")}.test(name)`);const o=c?0:l.value[a.showIndex].length;console.log("watch props.show: ",a.show);const t=await T.request("getDetails/programsPage",{query:{collection:"pcf-programs",condition:JSON.stringify({where:e,skip:o,limit:$,orderBy:"order asc",ordersWhere:`fountain_id=='${a.show.fountain_id}' && show_id=='${a.show._id}'
           && show_date== 1692374400000 && in(status, [1, 2, 3])`,ordersField:"_id, program_id, max(start) as startTime, max(end) as endTime",mediaField:"_id, name, producer, poster, duration",outWhere:"size(_id.orders) > 0",outField:"arrayElemAt(media_id, 0) as media, _id.orders as orders, price, type, tags"})}});g.value=!1,!t.success&&((u=t.error)==null?void 0:u.message)&&/resource exhausted/.test(t.error.message)&&(p.value="DB resource exhausted."),c?(console.log("loadMore isSearch res:",t),i.value=t):(t.length?(l.value[a.showIndex]=l.value[a.showIndex].concat(t),i.value=l.value[a.showIndex]):(l.value[a.showIndex]=[],i.value=[]),t.length<$&&(h.value[a.showIndex]=!0))}catch(c){console.error("loadMore ProgramsList:",c)}}function I(n){const u=i.value[n];k("selected",u)}function E(n,u){h.value[a.showIndex]?u(!0):x(a.search).then(()=>u())}function B(n){if(n){const u=[],c=RegExp(n,"i");for(const e of l.value[a.showIndex])e.media&&(c.test(e.media.name)||c.test(e.media.producer))&&u.push(e);i.value=u}else i.value=l.value[a.showIndex]}return(n,u)=>(m(),v("div",fe,[r(re,{showing:g.value,label:"\u52A0\u8F7D\u8282\u76EE\u6570\u636E ...","label-class":"text-teal","label-style":"font-size: 1.1em"},null,8,["showing"]),!g.value&&i.value.length?(m(),S(ie,{key:0,onLoad:E,offset:150},{loading:s(()=>[P("div",he,[r(ue,{color:"primary",size:"40px"})])]),default:s(()=>[r(ne,{separator:""},{default:s(()=>[(m(!0),v(L,null,U(i.value,(c,e)=>V((m(),S(N,{key:e,clickable:"",disable:!0,onClick:M(o=>I(e),["stop"])},{default:s(()=>[r(Q,{avatar:""},{default:s(()=>[r(O,{size:"xl",rounded:""},{default:s(()=>{var o,t;return[P("img",{src:(t=(o=c.media)==null?void 0:o.image)==null?void 0:t.url},null,8,pe)]}),_:2},1024)]),_:2},1024),r(Q,{class:"justify-around"},{default:s(()=>[r(q,{lines:"1"},{default:s(()=>{var o;return[y(w((o=c.media)==null?void 0:o.name),1)]}),_:2},1024),r(q,{lines:"1",caption:"",style:{"font-size":"12px"}},{default:s(()=>{var o;return[y(w((o=c.media)==null?void 0:o.producer),1)]}),_:2},1024)]),_:2},1024),r(Q,{side:"",class:"justify-around"},{default:s(()=>[r(le,{color:"green"},{default:s(()=>[y(w(c.tags.join("-")),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])),[[H]])),128))]),_:1})]),_:1})):A("",!0),p.value.length?(m(),v("div",ve,w(p.value),1)):A("",!0)]))}}),Ve=j({__name:"Tab3Page",setup(D){const _=de(),g=me(),p=d(!1),a=d(),l=d(),i=d(),h=d(),T=d(),k=d(!1),x=d(),I=d(),E=d(),B=R(()=>{var o,t,f;let e=((o=x.value)==null?void 0:o.clientHeight)||0;return e+=((t=I.value)==null?void 0:t.clientHeight)||0,e+=((f=E.value)==null?void 0:f.clientHeight)||0,{paddingTop:e+"px"}});G(async()=>{if(_.sessionStorage.has("__QPCF_TAB3_PAGE_STATUS")){const e=_.sessionStorage.getItem("__QPCF_TAB3_PAGE_STATUS");a.value=e.fountain,h.value=e.program,i.value=e.shows,T.value=e.programType,p.value=e.isFountain,l.value=e.currentTab,k.value=e.isSearchBar}}),Y(()=>{_.sessionStorage.set("__QPCF_TAB3_PAGE_STATUS",{isFountain:p.value,currentTab:l.value,fountain:a.value,program:h.value,shows:i.value,programType:T.value,isSearchBar:k.value}),console.log("Tab3 onUnmounted()")});async function n(e){if(e){a.value=e,p.value=!0;const t=await z.getInstance().request("databaseCRUD/get",{query:{collection:"pcf-shows",condition:JSON.stringify({fountain_id:e._id})}});console.log("shows res:",t);const f=ce(t.data);console.log("shows result:",f),i.value=f==null?void 0:f.shows,l.value=f?f.index:0}}function u(e){e&&(h.value=e,e.type&&(T.value=e.type,c()))}function c(){g.isShow&&g.toggleShow()}return(e,o)=>(m(),S(te,{style:J(B.value)},{default:s(()=>[p.value?(m(),v(L,{key:0},[a.value&&i.value?(m(),S(_e,{key:0,show:i.value[l.value],showIndex:l.value,showsLength:i.value.length,search:b(g).key,onSelected:u},null,8,["show","showIndex","showsLength","search"])):A("",!0)],64)):(m(),S(se,{key:1,onSelected:n})),r(ae,{expand:"",position:"top"},{default:s(()=>[r(ee,{class:"q-px-none items-center shadow-8",color:b(_).dark.isActive?"grey-10":"grey-2"},{default:s(()=>[r(K,{class:"text-subtitle1 text-center"},{default:s(()=>[p.value?(m(),v("div",{key:0,ref_key:"fn_card",ref:I},[r(oe,{data:a.value,onClick:o[0]||(o[0]=t=>p.value=!1)},null,8,["data"]),r(N,{dense:"",class:"text-caption"},{default:s(()=>[r(Q,{avatar:"",class:"text-caption text-grey-7"},{default:s(()=>[y(w(e.$t("weekdays").split(",")[Number(b(F).formatDate(new Date,"E"))-1]),1)]),_:1}),r(Q,{class:"text-caption text-primary"},{default:s(()=>[y(w(b(F).formatDate(new Date,"YYYY \u5E74 M \u6708 D \u65E5")),1)]),_:1}),r(Q,{class:"text-caption",side:""},{default:s(()=>[y(w(b(F).formatDate(new Date,"H:mm")),1)]),_:1})]),_:1}),i.value?(m(),v("div",{key:0,ref_key:"shows_bar",ref:E},[r(X,{modelValue:l.value,"onUpdate:modelValue":o[1]||(o[1]=t=>l.value=t),dense:"","inline-label":"",class:"col text-purple-3","active-color":"purple"},{default:s(()=>[(m(!0),v(L,null,U(i.value,(t,f)=>(m(),S(W,{class:"col",key:f,name:f,label:t.name.replace(/\s+/g,"")},null,8,["name","label"]))),128))]),_:1},8,["modelValue"])],512)):A("",!0)],512)):(m(),v("div",{key:1,ref_key:"step_bar",ref:x},[r(Z,{outline:"",ripple:!1,color:b(_).dark.isActive?"purple-3":"purple"},{default:s(()=>[y(" \u9009\u62E9\u55B7\u6CC9\uFF0C\u67E5\u770B\u5F53\u65E5\u8282\u76EE\u64AD\u653E\u5217\u8868 ")]),_:1},8,["color"])],512))]),_:1})]),_:1},8,["color"])]),_:1})]),_:1},8,["style"]))}});export{Ve as default};
