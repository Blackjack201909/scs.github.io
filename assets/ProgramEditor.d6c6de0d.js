import{d as A,r as c,l as T,w as Q,m as u,n as g,p as r,j as o,aT as V,x as y,s as i,G as L,H as v,A as x,B as _,y as U,bc as $,F as N,br as Y,Q as P}from"./index.4f390c6a.js";import{Q as G}from"./QForm.c09e6959.js";import{Q as H}from"./QPage.e32daf6c.js";import{u as K}from"./use-quasar.4e14d354.js";import{_ as J}from"./CollectionSelect.2d35001e.js";import{_ as W}from"./UpdatedDate.47641b74.js";import{U as X}from"./cloudDB.d318324a.js";import{m as Z}from"./index.d9f23821.js";import{u as ee}from"./SearchKey.a606d0cd.js";import"./QSelect.8ad877e3.js";import"./QChip.17ac3977.js";import"./QItemLabel.95b24a48.js";import"./QMenu.75c03351.js";import"./selection.1482bdb7.js";import"./rtl.0738a96b.js";import"./format.6396bb17.js";import"./constant.a3c7e21e.js";import"./index.4024674e.js";import"./date.865a2574.js";import"./axios.ea5872bc.js";const le={key:1,class:"q-mt-md row justify-center"},ae=["src"],te={class:"row col justify-between"},se={class:"row col justify-between"},oe={class:"row col justify-between"},ne={class:"q-mb-md rounded-borders",style:{border:"1px lightgrey solid"}},ue=i("div",null,"state",-1),re={class:"q-gutter-x-lg q-gutter-y-sm"},ie={class:"q-mb-md rounded-borders",style:{border:"1px lightgrey solid"}},de=i("div",null,"tags",-1),me={class:"q-gutter-x-md"},ce={key:0,class:"q-mb-md rounded-borders",style:{border:"1px lightgrey solid"}},pe=i("div",null,"state",-1),be={class:"q-gutter-x-lg q-gutter-y-sm"},ve={key:1,class:"q-mt-lg q-mb-xl row justify-between"},$e=A({__name:"ProgramEditor",setup(fe){const h=K(),E=ee(),f=c(!0),m=c("Submit"),p=c(""),q=c("");let F="",S=[];const w=c(""),j=c(""),O={\u55B7\u6CC9:Z,\u4E92\u52A8:"ion-hand",\u6C34\u5E55:"monitor",\u97F3\u4E50:"music_note",\u6FC0\u5149:"stylus_laser_pointer",\u706F\u5149:"wb_sunny"},b=c([{label:"\u6CC9",isEnable:!1},{label:"\u4E92",isEnable:!1},{label:"\u5F71",isEnable:!1},{label:"\u5531",isEnable:!1},{label:"\u4E50",isEnable:!1},{label:"\u6FC0",isEnable:!1},{label:"\u706F",isEnable:!1},{label:"\u706B",isEnable:!1},{label:"\u8BF4",isEnable:!1},{label:"\u5E86",isEnable:!1},{label:"\u5E74",isEnable:!1},{label:"\u7EA2",isEnable:!1},{label:"\u559C",isEnable:!1},{label:"\u767D",isEnable:!1}]),D={name:"",fountain_id:"",media_id:"",tags:[],price:1e4,type:"\u55B7\u6CC9",member_index:"xyz",order:0,name_duration:1e3,state:1},l=c(JSON.parse(JSON.stringify(D))),k=X.getInstance();T(()=>{E.isEnable||E.toggleEnable(),E.isShow&&E.toggleShow()}),Q(()=>l.value.type,t=>{if(typeof t=="string"){const a=Object.keys(O).findIndex(e=>e===t);j.value=a>=0?Object.values(O)[a]:""}},{immediate:!0}),Q([p,q],async([t,a])=>{var e,s;if(t&&a){let n="New program.";try{const d=await k.request("databaseCRUD/get",{query:{collection:"pcf-programs",condition:JSON.stringify({fountain_id:t,media_id:a})}});if(console.log("onMediaPick programs res:",d),S=[],(e=d.data)!=null&&e.length){S=d.data,l.value=JSON.parse(JSON.stringify(S[0])),b.value.forEach(B=>{l.value.tags&&(B.isEnable=l.value.tags.includes(B.label))}),console.log("watch media_id programTags:",b.value),l.value.state===void 0&&(l.value.state=1),m.value="Update";return}else!d.success&&((s=d.error)==null?void 0:s.message)&&(/resource exhausted/.test(d.error.message)?n="DB resource exhausted.":n="Fail to get program data. Check network.")}catch(d){n=typeof d=="string"?d:JSON.stringify(d)}C(),l.value.name=F,n.length&&h.notify({type:"negative",position:"center",message:n})}},{immediate:!0});function C(){l.value=JSON.parse(JSON.stringify(D)),b.value.forEach(t=>t.isEnable=!1),m.value="Submit"}async function z(){h.notify({type:"positive",position:"center",timeout:0,icon:"cloud_done",message:`${m.value} Program: ${l.value.name} ?`,actions:[{label:"Cancel",color:"white",handler:()=>{}},{label:"Yes",color:"yellow",handler:async()=>{if(console.log("onSubmit formData:",l.value),l.value.tags){const s=[];for(const n in b.value)b.value[n].isEnable&&s.push(b.value[n].label);l.value.tags=s}const t=l.value._id?{_id:l.value._id}:{fountain_id:p.value,name:l.value.name},a=Date.now(),e={...l.value,_id:void 0,updated_at:a};e.created_at||(e.created_at=a),console.log("onSubmit body:",e);try{const s=await k.request("databaseCRUD/update",{query:{collection:"pcf-programs",condition:JSON.stringify(t)},body:e});console.log("onSubmit res:",s),(s.affectedDocs>0||s.id)&&(l.value.created_at||(l.value.created_at=e.created_at),l.value.updated_at=e.updated_at,m.value==="Submit"&&(s.id&&(l.value._id=s.id),m.value="Update"))}catch(s){h.notify({type:"negative",position:"center",message:typeof s=="string"?s:JSON.stringify(s)})}}}]})}function M(){h.notify({message:`Delete ${l.value.name} ?`,type:"negative",position:"center",icon:"cloud_done",timeout:0,actions:[{label:"Cancel",color:"white",handler:()=>{}},{label:"Yes",color:"yellow",handler:async()=>{if(m.value="Update")try{const t=await k.request("databaseCRUD/delete",{query:{collection:"pcf-programs",condition:JSON.stringify({fountain_id:p.value,_id:l.value._id})}});console.log("onDelete program res:",t),t.deleted===1&&(E.key=l.value.name?l.value.name:"z",f.value=!1)}catch(t){h.notify({type:"negative",position:"center",icon:"remove_circle",timeout:0,message:`Delete Error: ${t}`})}}}]})}function I(t){console.log("onFountainPick id:",t==null?void 0:t._id),t&&t._id!==p.value?(p.value=t._id,f.value=!1):p.value=""}async function R(t){var a;console.log("onMediaPick data:",t),t&&t._id!==q.value?(w.value=(a=t.poster)!=null&&a.url?t.poster.url:"",q.value=t._id,F=`${t.name}_${t.producer}`):(q.value="",C())}return(t,a)=>(u(),g(H,{padding:"",class:"q-mx-sm"},{default:r(()=>[o(J,{enable_search:f.value,onSelected:I,onClick:a[0]||(a[0]=e=>f.value=!0)},null,8,["enable_search"]),o(J,{collection:"pcf-media",enable_search:!f.value,onSelected:R,onClick:a[1]||(a[1]=e=>f.value=!1)},null,8,["enable_search"]),l.value.created_at&&l.value.updated_at?(u(),g(W,{key:0,class:"q-my-md",created_at:l.value.created_at,updated_at:l.value.updated_at},null,8,["created_at","updated_at"])):V("",!0),w.value?(u(),y("div",le,[o(L,{size:"280px",rounded:""},{default:r(()=>[i("img",{src:w.value},null,8,ae)]),_:1})])):V("",!0),o(G,{class:"q-mt-lg",onSubmit:z,onReset:C},{default:r(()=>[o(v,{modelValue:l.value.name,"onUpdate:modelValue":a[2]||(a[2]=e=>l.value.name=e),label:"name",hint:"",outlined:"",dense:"",clearable:"","lazy-rules":"",rules:[e=>e.length>0||"Please type something"]},null,8,["modelValue","rules"]),i("div",te,[o(v,{class:"col-6 q-pr-sm",outlined:"",modelValue:l.value.name_duration,"onUpdate:modelValue":a[3]||(a[3]=e=>l.value.name_duration=e),modelModifiers:{number:!0},type:"number",label:"name duration",hint:"",dense:"",clearable:"","lazy-rules":"",rules:[e=>e&&e>0||"Please type something"]},null,8,["modelValue","rules"]),o(v,{class:"col-6 q-pl-sm",outlined:"",modelValue:l.value.price,"onUpdate:modelValue":a[4]||(a[4]=e=>l.value.price=e),modelModifiers:{number:!0},type:"number",label:"price",hint:"",dense:"",clearable:"","lazy-rules":"",rules:[e=>e>0||"Please type something"]},null,8,["modelValue","rules"])]),i("div",se,[o(v,{class:"col-6 q-pr-sm",modelValue:l.value.member_index,"onUpdate:modelValue":a[5]||(a[5]=e=>l.value.member_index=e),label:"member_index",hint:"",outlined:"",dense:"",clearable:"","lazy-rules":"",rules:[e=>e.length>0||"Please type something"]},null,8,["modelValue","rules"]),o(v,{class:"col-6 q-pl-sm",outlined:"",modelValue:l.value.order,"onUpdate:modelValue":a[6]||(a[6]=e=>l.value.order=e),modelModifiers:{number:!0},type:"number",label:"order",hint:"",dense:"",clearable:"","lazy-rules":"",rules:[e=>e>0||"Please type something"]},null,8,["modelValue","rules"])]),i("div",oe,[o(v,{class:"col-6 q-pr-sm",outlined:"",modelValue:l.value.price,"onUpdate:modelValue":a[7]||(a[7]=e=>l.value.price=e),modelModifiers:{number:!0},type:"number",label:"price",hint:"",dense:"",clearable:"","lazy-rules":"",rules:[e=>e>0||"Please type something"]},null,8,["modelValue","rules"]),o(v,{class:"col-6 q-pl-sm",outlined:"",modelValue:l.value.state,"onUpdate:modelValue":a[8]||(a[8]=e=>l.value.state=e),modelModifiers:{number:!0},type:"number",label:"state",hint:"",dense:"",clearable:"","lazy-rules":"",rules:[e=>e>=0||"Please type something"]},null,8,["modelValue","rules"])]),i("div",ne,[o(x,null,{default:r(()=>[o(_,{class:"q-mr-lg",avatar:""},{default:r(()=>[ue]),_:1}),o(_,{class:""},{default:r(()=>[i("div",re,[(u(!0),y(N,null,U(t.$t("type.program").split(","),(e,s)=>(u(),g($,{key:s,modelValue:l.value.type,"onUpdate:modelValue":a[9]||(a[9]=n=>l.value.type=n),val:s,label:e,dense:""},null,8,["modelValue","val","label"]))),128))])]),_:1})]),_:1})]),i("div",ie,[o(x,null,{default:r(()=>[o(_,{class:"q-mr-xs",avatar:""},{default:r(()=>[de]),_:1}),o(_,{class:""},{default:r(()=>[i("div",me,[(u(!0),y(N,null,U(b.value,e=>(u(),g(Y,{key:e.label,modelValue:e.isEnable,"onUpdate:modelValue":s=>e.isEnable=s,label:e.label,dense:""},null,8,["modelValue","onUpdate:modelValue","label"]))),128))])]),_:1})]),_:1})]),l.value.state?(u(),y("div",ce,[o(x,null,{default:r(()=>[o(_,{class:"q-mr-lg",avatar:""},{default:r(()=>[pe]),_:1}),o(_,{class:""},{default:r(()=>[i("div",be,[(u(!0),y(N,null,U(t.$t("state.program").split(","),(e,s)=>(u(),g($,{key:s,modelValue:l.value.state,"onUpdate:modelValue":a[10]||(a[10]=n=>l.value.state=n),val:s,label:e,dense:""},null,8,["modelValue","val","label"]))),128))])]),_:1})]),_:1})])):V("",!0),p.value&&l.value.media_id?(u(),y("div",ve,[m.value=="Update"?(u(),g(P,{key:0,dense:"",outline:"",color:"negative",icon:"remove",round:"",onClick:M})):V("",!0),o(P,{class:"q-px-md",dense:"","no-caps":"",unelevated:"",label:"Reset",type:"reset",color:"primary",icon:"restart_alt",outline:"",rounded:""}),o(P,{class:"q-px-md",dense:"",outline:"","no-caps":"",unelevated:"",label:m.value,type:"submit",color:"primary",icon:"cloud_upload",rounded:""},null,8,["label"])])):V("",!0)]),_:1})]),_:1}))}});export{$e as default};
