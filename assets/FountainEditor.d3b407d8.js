import{Q as K}from"./QImg.a4aaed75.js";import{d as W,r as b,l as X,w as q,m as u,n as c,p as m,j as s,aT as p,C as Z,s as i,t as R,G as ee,v as N,U as P,bb as B,Q as w,H as v,x as V,y as x,aU as le,F as C,A as I,B as O,br as ae,bc as te}from"./index.4f390c6a.js";import{Q as oe}from"./QSelect.8ad877e3.js";import{Q as se}from"./QForm.c09e6959.js";import{Q as ue}from"./QPage.e32daf6c.js";import{u as re}from"./use-quasar.4e14d354.js";import{Q as ne}from"./QFile.0b5cf431.js";import{c as ie,a as M}from"./locale-options.a93a5ee4.js";import{U as de,u as ce}from"./cloudDB.d318324a.js";import{u as me}from"./SearchKey.a606d0cd.js";import{m as A}from"./constant.a3c7e21e.js";import{_ as pe}from"./CollectionSelect.2d35001e.js";import{_ as ve}from"./UpdatedDate.47641b74.js";import"./QChip.17ac3977.js";import"./QItemLabel.95b24a48.js";import"./QMenu.75c03351.js";import"./selection.1482bdb7.js";import"./rtl.0738a96b.js";import"./format.6396bb17.js";import"./axios.ea5872bc.js";import"./index.d9f23821.js";import"./index.4024674e.js";import"./date.865a2574.js";const fe={class:"absolute-bottom"},ye={class:"text-subtitle2"},be={class:"q-pt-none"},_e={class:"row col justify-between"},ge={class:"col-3"},he=["src"],we={class:"col-9 q-pl-md"},Ve={class:"row col justify-between"},Se={class:"col row justify-between"},ke={class:"q-mb-md rounded-borders",style:{border:"1px lightgrey solid"}},Ue=i("div",null,"program types",-1),qe={class:"q-gutter-x-md q-gutter-y-sm"},Ne={key:3,class:"row col justify-between"},Ce={key:4,class:"q-mb-md rounded-borders",style:{border:"1px lightgrey solid"}},Oe=i("div",null,"state",-1),Ee={class:"q-gutter-x-lg q-gutter-y-sm"},Qe={class:"q-mt-lg q-mb-xl row justify-between"},al=W({__name:"FountainEditor",setup(Je){const S=re(),k=me(),y=b("Submit"),f=b({poster:null}),E=b(null),g=b(""),U=b(""),h=b(["0","0"]),_=b([{label:"\u55B7\u6CC9",isEnable:!1},{label:"\u4E92\u52A8",isEnable:!1},{label:"\u6C34\u5E55",isEnable:!1},{label:"\u97F3\u4E50",isEnable:!1},{label:"\u6FC0\u5149",isEnable:!1},{label:"\u706F\u5149",isEnable:!1}]),Q={name:"",alias:"",address:"",image:{url:""},poster:{url:""},coordinate:"0,0",iso_country_code:"CN",program_types:[],play_server:"",ws_server:"",schedule_length:{power_off:0,shutdown:0,startup:0,warm:0},state:3},e=b(JSON.parse(JSON.stringify(Q)));let r;const F=de.getInstance();X(async()=>{k.isEnable||k.toggleEnable(),k.isShow&&k.toggleShow()}),q(()=>h.value,t=>{e.value.coordinate=t.join(","),console.log("watch coordinate:",e.value.coordinate),console.log("watch coordinate type:",typeof e.value.coordinate)},{immediate:!0,deep:!0}),q(()=>e.value.iso_country_code,t=>{if(t){const a=M.find(n=>n.value===t);a?g.value!==a.label&&(U.value=`img:${a.image}`,g.value=a.label):(U.value="",g.value="")}},{immediate:!0}),q(()=>g.value,t=>{if(t){const a=M.find(n=>n.label===t);a?e.value.iso_country_code!==a.value&&(U.value=`img:${a.image}`,e.value.iso_country_code=a.value):(U.value="",e.value.iso_country_code="")}},{immediate:!0}),q(()=>f.value.poster,t=>{t&&e.value.poster&&(e.value.poster.url=URL.createObjectURL(t),e.value.poster.name=t.name,e.value.poster.type=t.type)});function L(t){var a;t?(r=JSON.parse(JSON.stringify(t)),e.value=JSON.parse(JSON.stringify(t)),_.value.forEach(n=>{e.value.program_types&&(n.isEnable=e.value.program_types.includes(n.label))}),console.log("watch fountainName programTypes:",_.value),(a=e.value.poster)!=null&&a.url||(e.value.poster={url:""}),h.value=["0","0"],e.value.coordinate&&(h.value=e.value.coordinate.split(",")),!e.value.created_at&&e.value.updated_at&&(e.value.created_at=e.value.updated_at),y.value="Update"):(e.value=JSON.parse(JSON.stringify(Q)),r=t,y.value="Submit")}function z(){E.value&&E.value.pickFiles()}function T(){if(console.log("onRestorePosterUrl formData.value:",e.value),e.value.poster){const t=r==null?void 0:r.poster;console.log("onRestorePosterUrl fountain.poster:",t),e.value.poster=t?JSON.parse(JSON.stringify(t)):{url:""},f.value.poster=null}}function D(){var t;f.value.poster=null,(t=e.value.poster)!=null&&t.url&&(e.value.poster.url="")}function $(){r?e.value=JSON.parse(JSON.stringify(r)):(e.value=JSON.parse(JSON.stringify(Q)),_.value.forEach(t=>t.isEnable=!1),y.value="Submit")}async function Y(){S.notify({type:"positive",position:"center",timeout:0,icon:"cloud_done",message:`${y.value} Fountain: ${e.value.name} ?`,actions:[{label:"Cancel",color:"white",handler:()=>{}},{label:"Yes",color:"yellow",handler:async()=>{var l;if(console.log("onSubmit formData:",e.value),e.value.program_types){const o=[];for(const d in _.value)_.value[d].isEnable&&o.push(_.value[d].label);e.value.program_types=o}const t=e.value._id?{_id:e.value._id}:{name:e.value.name},a=Date.now(),n={...e.value,_id:void 0,updated_at:a};if(n.created_at||(n.created_at=a),console.log("onSubmit body:",n),f.value.poster){const o=((l=r==null?void 0:r.poster)==null?void 0:l.url)||"";let d="",J;if(o&&!o.includes("blob:http")&&(J=o),d=await ce(f.value.poster,J),d&&e.value.poster&&(f.value.poster=null,e.value.poster.url=d,J)){const j=r==null?void 0:r.poster;j&&(j.url=d)}}try{const o=await F.request("databaseCRUD/update",{query:{collection:"pcf-fountains",condition:JSON.stringify(t)},body:JSON.stringify(n)});console.log("onSubmit res:",o),(o.affectedDocs>0||o.id)&&(e.value.created_at||(e.value.created_at=n.created_at),e.value.updated_at=n.updated_at,y.value==="Submit"&&(o.id&&(e.value._id=o.id,r=JSON.parse(JSON.stringify(e.value))),y.value="Update"))}catch(o){S.notify({type:"negative",position:"center",message:typeof o=="string"?o:JSON.stringify(o)})}}}]})}function G(){S.notify({message:"Add a New Show ?",type:"positive",position:"center",icon:"cloud_done",timeout:0,actions:[{label:"Cancel",color:"white",handler:()=>{}},{label:"Yes",color:"yellow",handler:async()=>{$()}}]})}function H(){S.notify({message:`Delete ${e.value.name} ?`,type:"negative",position:"center",icon:"cloud_done",timeout:0,actions:[{label:"Cancel",color:"white",handler:()=>{}},{label:"Yes",color:"yellow",handler:async()=>{if(r&&e.value)try{const t=await F.request("databaseCRUD/delete",{query:{collection:"pcf-fountains",condition:JSON.stringify({_id:e.value._id})}});console.log("onDelete program res:",t),t.deleted===1&&(k.key=r.alias?r.alias:"z")}catch(t){S.notify({type:"negative",position:"center",icon:"remove_circle",timeout:0,message:`Delete Show ${e.value.name} Error: ${t}`})}}}]})}return(t,a)=>(u(),c(ue,{padding:"",class:"q-mx-sm"},{default:m(()=>{var n;return[s(pe,{onSelected:L}),e.value.created_at&&e.value.updated_at?(u(),c(ve,{key:0,class:"q-my-md",created_at:e.value.created_at,updated_at:e.value.updated_at},null,8,["created_at","updated_at"])):p("",!0),(n=e.value.poster)!=null&&n.url?(u(),c(Z,{key:1,class:"q-my-lg my-card",onClick:z},{default:m(()=>[s(K,{src:e.value.poster.url},{default:m(()=>[i("div",fe,[i("div",ye,R(e.value.name),1),i("div",be,R(e.value.address),1)])]),_:1},8,["src"])]),_:1})):p("",!0),s(se,{class:"q-mt-lg",onSubmit:Y,onReset:$},{default:m(()=>[i("div",_e,[i("div",ge,[s(ee,{size:"96px",rounded:"",onClick:z},{default:m(()=>{var l;return[i("img",{src:(l=e.value.poster)==null?void 0:l.url},null,8,he)]}),_:1})]),i("div",we,[s(N(ne),{ref_key:"posterPicker",ref:E,dense:"",class:"q-mb-md",outlined:"",modelValue:f.value.poster,"onUpdate:modelValue":a[0]||(a[0]=l=>f.value.poster=l),label:"load image",accept:"image/*"},{append:m(()=>[f.value.poster!==null?(u(),c(P,{key:0,name:N(A),onClick:B(D,["stop","prevent"]),class:"cursor-pointer",color:"grey-5"},null,8,["name"])):(u(),c(w,{key:1,round:"",dense:"",flat:"",icon:"folder_open"}))]),_:1},8,["modelValue"]),e.value.poster?(u(),c(v,{key:0,modelValue:e.value.poster.url,"onUpdate:modelValue":a[1]||(a[1]=l=>e.value.poster.url=l),outlined:"",label:"poster url",hint:"",dense:"","lazy-rules":"",rules:[l=>l.length>=0||"Please type something"]},{append:m(()=>[f.value.poster||!e.value.poster.url?(u(),c(w,{key:0,round:"",dense:"",flat:"",icon:"restart_alt",onClick:T})):p("",!0),e.value.poster.url?(u(),c(P,{key:1,name:N(A),color:"grey-5",onClick:B(D,["stop","prevent"]),class:"cursor-pointer"},null,8,["name"])):p("",!0)]),_:1},8,["modelValue","rules"])):p("",!0)])]),s(v,{class:"",modelValue:e.value.name,"onUpdate:modelValue":a[2]||(a[2]=l=>e.value.name=l),label:"name zh",outlined:"",dense:"",clearable:"","lazy-rules":"",rules:[l=>l.length>0||"Please type something"]},null,8,["modelValue","rules"]),e.value.address?(u(),c(v,{key:0,class:"",outlined:"",modelValue:e.value.address,"onUpdate:modelValue":a[3]||(a[3]=l=>e.value.address=l),label:"address",hint:"",dense:"",clearable:"","lazy-rules":"",rules:[l=>l.length>0||"Please type something"]},null,8,["modelValue","rules"])):p("",!0),i("div",Ve,[s(v,{class:"col-6 q-pr-sm",outlined:"",modelValue:e.value.alias,"onUpdate:modelValue":a[4]||(a[4]=l=>e.value.alias=l),label:"alias",hint:"",dense:"",clearable:"","lazy-rules":"",rules:[l=>l.length>=0||"Please type something"]},null,8,["modelValue","rules"]),s(oe,{class:"col-6 q-pl-sm",outlined:"",modelValue:g.value,"onUpdate:modelValue":a[5]||(a[5]=l=>g.value=l),options:N(ie),dense:"","options-dense":!1,"hide-dropdown-icon":"",label:"country / region","stack-label":""},{append:m(()=>[s(P,{name:U.value},null,8,["name"])]),_:1},8,["modelValue","options"])]),i("div",Se,[(u(!0),V(C,null,x(h.value,(l,o)=>(u(),c(v,{key:o,class:le(["col-6",o==0?"q-pr-sm":"q-pl-sm"]),outlined:"",modelValue:h.value[o],"onUpdate:modelValue":d=>h.value[o]=d,type:"text",hint:"",dense:"",label:o==0?"longitude":"latitude","lazy-rules":"",clearable:"",rules:[d=>Number(d)==0||/^[0-9]+\.[0-9]+$/.test(d)||"0 or float"]},null,8,["class","modelValue","onUpdate:modelValue","label","rules"]))),128))]),i("div",ke,[s(I,null,{default:m(()=>[s(O,{class:"q-mr-xs",avatar:""},{default:m(()=>[Ue]),_:1}),s(O,{class:""},{default:m(()=>[i("div",qe,[(u(!0),V(C,null,x(_.value,l=>(u(),c(ae,{key:l.label,modelValue:l.isEnable,"onUpdate:modelValue":o=>l.isEnable=o,label:l.label,dense:""},null,8,["modelValue","onUpdate:modelValue","label"]))),128))])]),_:1})]),_:1})]),e.value.play_server?(u(),c(v,{key:1,class:"",outlined:"",modelValue:e.value.play_server,"onUpdate:modelValue":a[6]||(a[6]=l=>e.value.play_server=l),label:"play_server",hint:"",dense:"",clearable:"","lazy-rules":"",rules:[l=>l.length>=0||"Please type something"]},null,8,["modelValue","rules"])):p("",!0),e.value.ws_server?(u(),c(v,{key:2,class:"",outlined:"",modelValue:e.value.ws_server,"onUpdate:modelValue":a[7]||(a[7]=l=>e.value.ws_server=l),label:"ws_server",hint:"",dense:"",clearable:"","lazy-rules":"",rules:[l=>l.length>=0||"Please type something"]},null,8,["modelValue","rules"])):p("",!0),e.value.schedule_length?(u(),V("div",Ne,[s(v,{class:"col-6 q-pr-sm",outlined:"",modelValue:e.value.schedule_length.power_off,"onUpdate:modelValue":a[8]||(a[8]=l=>e.value.schedule_length.power_off=l),modelModifiers:{number:!0},type:"number",label:"power_off",hint:"",dense:"",clearable:"","lazy-rules":"",rules:[l=>l>=0||"Please type something"]},null,8,["modelValue","rules"]),s(v,{class:"col-6 q-pl-sm",outlined:"",modelValue:e.value.schedule_length.shutdown,"onUpdate:modelValue":a[9]||(a[9]=l=>e.value.schedule_length.shutdown=l),modelModifiers:{number:!0},type:"number",label:"shutdown",hint:"",dense:"",clearable:"","lazy-rules":"",rules:[l=>l>=0||"Please type something"]},null,8,["modelValue","rules"]),s(v,{class:"col-6 q-pr-sm",outlined:"",modelValue:e.value.schedule_length.startup,"onUpdate:modelValue":a[10]||(a[10]=l=>e.value.schedule_length.startup=l),modelModifiers:{number:!0},type:"number",label:"startup",hint:"",dense:"",clearable:"","lazy-rules":"",rules:[l=>l>=0||"Please type something"]},null,8,["modelValue","rules"]),s(v,{class:"col-6 q-pl-sm",outlined:"",modelValue:e.value.schedule_length.warm,"onUpdate:modelValue":a[11]||(a[11]=l=>e.value.schedule_length.warm=l),modelModifiers:{number:!0},type:"number",label:"warm",hint:"",dense:"",clearable:"","lazy-rules":"",rules:[l=>l>=0||"Please type something"]},null,8,["modelValue","rules"])])):p("",!0),e.value.state?(u(),V("div",Ce,[s(I,null,{default:m(()=>[s(O,{class:"q-mr-lg",avatar:""},{default:m(()=>[Oe]),_:1}),s(O,{class:""},{default:m(()=>[i("div",Ee,[(u(!0),V(C,null,x(t.$t("state.fountain").split(","),(l,o)=>(u(),c(te,{key:o,modelValue:e.value.state,"onUpdate:modelValue":a[12]||(a[12]=d=>e.value.state=d),val:o,label:l,dense:""},null,8,["modelValue","val","label"]))),128))])]),_:1})]),_:1})])):p("",!0),i("div",Qe,[y.value=="Update"?(u(),V(C,{key:0},[s(w,{dense:"",outline:"",color:"negative",icon:"add",round:"",onClick:G}),s(w,{dense:"",outline:"",color:"negative",icon:"remove",round:"",onClick:H})],64)):p("",!0),s(w,{class:"q-px-md",dense:"","no-caps":"",unelevated:"",label:"Reset",type:"reset",color:"primary",icon:"restart_alt",outline:"",rounded:""}),s(w,{class:"q-px-md",dense:"",outline:"","no-caps":"",unelevated:"",label:y.value,type:"submit",color:"primary",icon:"cloud_upload",rounded:""},null,8,["label"])])]),_:1})]}),_:1}))}});export{al as default};
