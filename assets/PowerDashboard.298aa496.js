import{Q as J}from"./QPage.e32daf6c.js";import{U as G,c as L}from"./cloudDB.d318324a.js";import{g as M,s as $}from"./constant.a3c7e21e.js";import{Q as x}from"./QItemLabel.95b24a48.js";import{d as z,r as i,c as B,w as A,m as c,x as p,n as _,p as w,A as H,aT as y,aU as N,D as K,j as b,q as R,t as W,v as q,aV as X,B as O,s as Y,Q as T,_ as Z,l as ee,a as le,F as U,y as V}from"./index.4f390c6a.js";import{_ as oe}from"./GroupSelect.989d4c58.js";import{u as ae}from"./use-quasar.4e14d354.js";import"./axios.ea5872bc.js";import"./QSelect.8ad877e3.js";import"./QChip.17ac3977.js";import"./QMenu.75c03351.js";import"./selection.1482bdb7.js";import"./rtl.0738a96b.js";import"./format.6396bb17.js";import"./index.4024674e.js";const te={class:"row justify-evenly"},ne=z({__name:"PowerButtons",props:{name:{},motor:{type:Boolean},status:{},setting:{},disable:{type:Boolean}},emits:["selected"],setup(Q,{emit:C}){const l=Q,f=C,o=i([{label:"\u5408\u95F8",value:"offline"},{label:"\u5206\u95F8",value:"offline"},{label:"\u50A8\u80FD",value:"offline"}]),s=i(null),u=i(),v=i(),r=i(),F=i(),d=B(()=>{let e="light-grey";return l.status&&l.status!=="offline"&&(l.status!==o.value[0].value?e="orange":e=o.value[0].value==="on"?"positive":"negative"),e}),I=B(()=>{let e="light-grey";return l.status&&l.status!=="offline"&&(l.status!==o.value[1].value?e=o.value[1].value==="on"?"positive":"negative":e="orange"),e}),P=B(()=>{console.log("computed toggleColor name: %s, props.status: %s",l.name,l.status);let e="grey";if(l.status&&l.status!=="offline"&&s.value!==null)if(l.name==="lock")e="primary";else return s.value!==(l.status==="on")?"warning":s.value?"positive":"negative";return console.log("computed toggleColor name: %s, color: %s",l.name,e),e}),S=B(()=>{var a;console.log("computed borderStyle name: %s, props.status: %s",l.name,l.status);let e={borderColor:"grey"};return l.name==="lock"?e={borderColor:"blue"}:l.status&&l.status!=="offline"&&((a=l.name)!=null&&a.includes("cabinet")?o.value[0].value!==l.status?e={borderColor:"orange"}:e={borderColor:o.value[0].value==="on"?"green":"red"}:s.value!==(l.status==="on")?e={borderColor:"orange"}:e={borderColor:s.value?"green":"red"}),console.log("computed borderStyle name: %s, bc: %s",l.name,JSON.stringify(e)),e});A(()=>l.status,e=>{typeof e=="string"&&e==="offline"&&(s.value=null)},{immediate:!0}),A(()=>l.setting,e=>{var a;console.log("watch name: %s, setting: %s",l.name,e),typeof e=="string"&&e.length&&(l.name==="lock"?u.value&&s.value?(console.log("watch name: %s, toggleSwitch.toggle()",l.name),u.value.toggle()):s.value===null&&(s.value=e==="on"):(a=l.name)!=null&&a.includes("cabinet")?["on","off"].includes(e)&&o.value[0].value!==e&&(o.value[0].value==="offline"?(o.value[0].value=e,o.value[1].value=e==="on"?"off":"on",l.motor&&(o.value[2].value="off")):e==="on"?v.value&&v.value.click():r.value&&r.value.click()):(console.log("watch name: %s, toggleSwitch: %s",l.name,s.value),e==="offline"?s.value=null:s.value!==(e==="on")&&(s.value===null?s.value=e==="on":u.value&&u.value.toggle())))},{immediate:!0});function k(e){if(o.value.length){o.value[e].value="on";let a="";o.value[e].label==="\u5408\u95F8"?(a="on",o.value[e+1].value="off",l.motor&&(o.value[e+2].value="off")):o.value[e].label==="\u5206\u95F8"?(a="off",o.value[e-1].value="off",l.motor&&(o.value[e+1].value="off")):o.value[e].label==="\u50A8\u80FD"&&(a="motor",l.status==="on"?(o.value[e].value="off",a="none"):(o.value[e-1].value="off",o.value[e-2].value="off")),f("selected",`${l.name}_${a}`)}}function D(e){typeof e=="boolean"&&f("selected",`${l.name}_${e?"on":"off"}`)}return(e,a)=>{var t;return c(),p("div",{class:N(["power_buttons",(t=e.name)!=null&&t.includes("cabinet")?"q-py-sm":"q-py-xs"]),style:K(S.value)},[e.name&&e.status?(c(),_(H,{key:0,class:"",dense:"",outlined:""},{default:w(()=>[b(O,{class:"",avatar:e.name.includes("cabinet")},{default:w(()=>[b(x,null,{default:w(()=>[R(W(e.name.toUpperCase()),1)]),_:1}),e.name.includes("cabinet")?y("",!0):(c(),_(q(X),{key:0,ref_key:"pwrToggle",ref:u,class:"",label:s.value?"ON ":s.value===null?"UNKNOWN ":"OFF ",modelValue:s.value,"onUpdate:modelValue":[a[0]||(a[0]=n=>s.value=n),D],disable:e.status==="offline"||e.disable,size:"lg","keep-color":s.value!==null&&e.name!=="lock",color:P.value,"left-label":""},null,8,["label","modelValue","disable","keep-color","color"]))]),_:1},8,["avatar"]),e.name.includes("cabinet")?(c(),_(O,{key:0,class:""},{default:w(()=>[Y("div",te,[e.motor?(c(),_(q(T),{key:0,ref_key:"storeButton",ref:F,label:"\u50A8\u80FD",outline:"",round:"",color:e.status==="offline"?"light-grey":o.value[2].value==="on"?"positive":"negative",disable:e.status==="offline"||e.disable,onClick:a[1]||(a[1]=n=>k(2))},null,8,["color","disable"])):y("",!0),b(q(T),{ref_key:"onButton",ref:v,label:"\u5408\u95F8",outline:"",round:"",color:d.value,disable:e.status==="offline"||e.disable,onClick:a[2]||(a[2]=n=>k(0))},null,8,["color","disable"]),b(q(T),{ref_key:"offButton",ref:r,label:"\u5206\u95F8",outline:"",round:"",color:I.value,disable:e.status==="offline"||e.disable,onClick:a[3]||(a[3]=n=>k(1))},null,8,["color","disable"])])]),_:1})):y("",!0)]),_:1})):y("",!0)],6)}}});var j=Z(ne,[["__scopeId","data-v-021740c8"]]);const se={key:0,class:"row q-mt-md q-mb-lg q-gutter-y-sm"},ue={key:1,class:"row q-mt-lg q-mb-lg q-gutter-y-sm"},Ce=z({__name:"PowerDashboard",setup(Q){const C=ae(),l=i(),f=i(),o=i([]),s=i([]),u=i([]),v=i([]);i();const r=i([]),F=G.getInstance();let d;ee(async()=>{if(C.sessionStorage.has("__QPCF_TAB1_PAGE_STATUS")){const e=C.sessionStorage.getItem("__QPCF_TAB1_PAGE_STATUS");console.log("power-dashboards onBeforeMount status:",e),l.value=e.fountain._id}}),le(()=>{d&&clearInterval(d)});async function I(e){var a;if(console.log("onDocumentPick doc:",e),f.value=void 0,o.value=[],u.value=[],r.value=[],s.value=[],v.value=[],e){f.value=e;for(const t of Object.keys(f.value))(M()!=="Night"?["night","projectors","lasers","lightings"]:["day"]).includes(t)&&(o.value.push({name:t}),u.value.push("off"),r.value.push(!0));try{const t=await F.request("databaseCRUD/get",{query:{collection:"pcf-switch-commands",condition:JSON.stringify({fountain_id:l.value})}});if(t.affectedDocs>0&&((a=t.data)==null?void 0:a.length)){for(const n of t.data)n.on&&(s.value.push(n),u.value.push("off"),r.value.push(!0));P(),o.value.unshift({name:"lock"}),u.value.unshift("off"),r.value.unshift(!1),v.value.push(...u.value),console.log("onDocumentPick switchCommands:",s.value)}}catch(t){console.error("cloudObj switch-commands:",t)}}}function P(){d&&clearInterval(d),d=setInterval(()=>{L("powerConsole/status",{host:"http://2.16.1.77:3002",timeout:3e4}).then(e=>{if(e&&JSON.stringify(e)!=="{}"){let a;for(a in e){const t=s.value.findIndex(n=>n.name===a);t>-1&&(u.value[t+o.value.length]=e[a])}if(f.value){let t;for(t in f.value){const n=o.value.findIndex(g=>g.name===t);if(n>-1){const g=f.value[t];let m="";for(const h of g)if(e[h]==="offline"){m="offline";break}else e[h]==="off"?m="off":e[h]==="on"&&m===""&&(m="on");u.value[n]=m}}}}}).catch(()=>{for(let e=1;e<u.value.length;e++)u.value[e]="offline"})},2e3)}async function S(e){console.log("onPowerChanged cmd",e);const a=e.split("_");if(a[0]==="lock"){for(let t=1;t<r.value.length;t++)r.value[t]=a[1]==="off";console.log("onPowerChanged disableFlags.value",r.value)}else{k();const t=s.value.findIndex(n=>n.name===a[0]);t>-1?a[1]!=="none"&&(await $(500),u.value[t+o.value.length]=a[1]==="on"?"on":"off"):await D(a[0],a[1])}}function k(){for(let e=1;e<r.value.length;e++)r.value[e]=!0;v.value[0]=v.value[0]==="on"?"off":"on"}async function D(e,a){if(o.value.findIndex(n=>n.name===e)>-1&&f.value){let n=[],g;for(g in f.value)if(g===e){n=f.value[g];break}for(let m of n){console.log("comboSendCommands combo item:",m);const h=s.value.findIndex(E=>E.name===m);h>-1&&(v.value[h+o.value.length]=a,await $(1e3))}}}return(e,a)=>(c(),_(J,{padding:"",class:"q-mx-sm"},{default:w(()=>[b(oe,{class:"q-mt-sm",collection:"pcf-power-dashboards",id:l.value,onSelected:I},null,8,["id"]),o.value.length?(c(),p("div",se,[(c(!0),p(U,null,V(o.value,(t,n)=>(c(),p("div",{key:n,class:N(n%2===0?"col-6 q-pr-xs":"col-6 q-pl-xs")},[b(j,{status:u.value[n],name:t.name,motor:typeof t.motor=="string"&&t.motor.length>2,disable:r.value[n],setting:v.value[n],onSelected:S},null,8,["status","name","motor","disable","setting"])],2))),128))])):y("",!0),s.value.length?(c(),p("div",ue,[(c(!0),p(U,null,V(s.value,(t,n)=>(c(),p("div",{key:n,class:N(t.name.includes("cabinet")?"col-12":n%2===0?"col-6 q-pr-xs":"col-6 q-pl-xs")},[b(j,{status:u.value[n+o.value.length],name:t.name,motor:typeof t.motor=="string"&&t.motor.length>2,disable:r.value[n+o.value.length],setting:v.value[n+o.value.length],onSelected:S},null,8,["status","name","motor","disable","setting"])],2))),128))])):y("",!0)]),_:1}))}});export{Ce as default};
